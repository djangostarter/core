name: Publish to PyPI

on:
  push:
    # 仅当推送形如 v1.0.0 的 tag 时触发（GitHub 这里是 glob，不是正则）
    # 为了避免 v1.0.0-rc1 之类误触发，后续步骤会做严格的 SemVer 校验。
    tags:
      - "v*.*.*"
  # 允许在 GitHub UI 手动触发（不会自动发布，仍会跑版本校验与构建流程）
  workflow_dispatch: {}

permissions:
  contents: read
  # 若你在 PyPI 侧配置了 Trusted Publisher（OIDC），需要开启该权限
  id-token: write

jobs:
  build-and-publish:
    name: Build and publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # hatch-vcs / setuptools-scm 需要能拿到 tag 信息
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # pyproject.toml 声明 requires-python >= 3.12
          python-version: "3.12"
          cache: "pip"

      - name: Validate tag and set release version
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          set -euo pipefail

          # 1) 只允许严格 SemVer: vMAJOR.MINOR.PATCH
          TAG_NAME="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG_NAME" ]]; then
            echo "GITHUB_REF_NAME is empty; expected to be a tag like v1.0.0"
            exit 1
          fi
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$TAG_NAME' is not a strict SemVer tag like v1.0.0"
            exit 1
          fi

          # 2) 让构建产物版本完全由 tag 决定（不需要手动改 pyproject.toml）
          # hatch-vcs 基于 setuptools-scm；该环境变量会成为版本的最高优先级来源。
          RELEASE_VERSION="${TAG_NAME#v}"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> "$GITHUB_ENV"
          echo "SETUPTOOLS_SCM_PRETEND_VERSION=$RELEASE_VERSION" >> "$GITHUB_ENV"
          echo "Release version: $RELEASE_VERSION"

      - name: Install build tooling
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # build: 负责执行 PEP 517 构建（会调用 hatchling）
          # twine: 用于检查分发包元数据
          python -m pip install --upgrade build twine

      - name: Build sdist and wheel
        shell: bash
        run: |
          set -euo pipefail
          python -m build

      - name: Verify distributions
        shell: bash
        run: |
          set -euo pipefail
          python -m twine check --strict dist/*

      # 发布方式 A：API Token（最通用）
      # 1) 在 PyPI 创建 token
      # 2) 在 GitHub 仓库 Settings -> Secrets and variables -> Actions 添加：
      #    PYPI_API_TOKEN = pypi-****
      - name: Publish to PyPI (token)
        if: ${{ startsWith(github.ref, 'refs/tags/v') && secrets.PYPI_API_TOKEN != '' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      # 发布方式 B：Trusted Publisher（OIDC，更安全，无需保存 token）
      # 需要你在 PyPI 项目设置里将该 GitHub 仓库配置为 Trusted Publisher。
      - name: Publish to PyPI (trusted publishing)
        if: ${{ startsWith(github.ref, 'refs/tags/v') && secrets.PYPI_API_TOKEN == '' }}
        uses: pypa/gh-action-pypi-publish@release/v1
